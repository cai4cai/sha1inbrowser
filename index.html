<!DOCTYPE html>
<html>
<head>
   <meta charset="UTF-8">
   <title>Compute SHA-1 from CSV in browser</title>
   <style>
      table, th, td {
         border: 1px solid black;
         border-collapse: collapse;
      }
      #preview {
         display: none;
      }
   </style>
</head>
<body>
   <h1>Choose a CSV file</h1>
   <form id="myForm">
      <input type="file" id="csvFile" accept=".csv" />
      <br />
      <input type="submit" value="Process" />
   </form>
   <div id="preview">
      <h1>Data preview</h1>
      <p id="previewLbl">Showing 0 of 0</p>
      <table id="previewTable">
         <thead>
            <tr>
               <th>Col A</th>
               <th>Col B</th>
               <th>Col C</th>
            </tr>
         </thead>
         <tbody id="previewTableBody"></tbody>
      </table>
   </div>
   <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
   <script>
      async function sha1(str) {
         const enc = new TextEncoder();
         const hash = await crypto.subtle.digest('SHA-1', enc.encode(str));
         return Array.from(new Uint8Array(hash))
            .map(v => v.toString(16).padStart(2, '0'))
            .join('');
      }
   </script>
   <script>
      function download(dataurl, filename) {
         const link = document.createElement("a");
         link.href = dataurl;
         link.download = filename;
         link.click();
      }

      function setPreviewVisible(visible) {
         document.getElementById("preview").style.display = (visible ? "block" : "none");
      }

      function clearTable() {
         const table = document.getElementById("previewTable");
         table.tBodies[0].innerHTML = "";
      }
   </script>
   <script>
      const myForm = document.getElementById("myForm");
      const csvFile = document.getElementById("csvFile");

      myForm.addEventListener("submit", function (e) {
         e.preventDefault();
         const input = csvFile.files[0];
         const reader = new FileReader();

         // ðŸ‘‡ executed when a file is loaded
         reader.onload = async function (e) {
            // ðŸ‘‡ get the text from CSV file
            const text = e.target.result;

            // ðŸ‘‡ parse it using D3.js
            const data = d3.csvParse(text);

            for (var i = 0; i < data.length; i++) {
               stringtohash = data[i]["Col A"] + data[i]["Col B"] + data[i]["Col C"]; 
               console.log("Hashing: " + stringtohash);
               hash = await sha1(data[i]["Col A"]);
               console.log("SHA-1: " + hash);

               data[i]["Hash"] = hash;
            }

            var csvContent = "data:text/csv;charset=utf-8," + encodeURI(d3.csvFormat(data));;
            download(csvContent, "parsedcsv.csv");
         };

         reader.readAsText(input);
      });

      csvFile.addEventListener("change", function (e) {
         e.preventDefault();
         const input = csvFile.files[0];
         const reader = new FileReader();

         setPreviewVisible(input != null);
         if (input == null) {
            clearTable();
            return;
         }

         // ðŸ‘‡ executed when a file is loaded
         reader.onload = async function (e) {
            // ðŸ‘‡ get the text from CSV file
            const text = e.target.result;

            // ðŸ‘‡ parse it using D3.js
            const data = d3.csvParse(text);

            // Get object for preview table
            const previewTableBody = document.getElementById("previewTableBody");

            // Add rows to preview table
            const toShow = Math.min(data.length, 10);
            for (let i = 0; i < toShow; i++) {
               const row = previewTableBody.insertRow(i);
               for (let j = 0; j < data.columns.length; j++) {
                  row.insertCell(j).innerHTML = data[i][data.columns[j]];
               }
            }

            // Show size of dataset
            document.getElementById("previewLbl").innerHTML = "Showing " + toShow + " of " + data.length;
         };

         // ðŸ‘‡ load the input file to the reader
         reader.readAsText(input);
      });
   </script>
</body>
</html>
