<!DOCTYPE html>
<html>
<head>
   <meta charset="UTF-8">
   <title>Compute SHA-1 from CSV in browser</title>
   <style>
      #options {
         display: none;
      }
   </style>
</head>
<body>
   <form id="myForm">
      <input type="file" id="csvFile" accept=".csv" />
      <br />
      <input type="submit" value="Process" />
   </form>
   <div id="options">
      <h1>Field options</h1>
      <div id="columnBoxes"></div>
   </div>
   <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
   <script>
      async function sha1(str) {
         const enc = new TextEncoder();
         const hash = await crypto.subtle.digest('SHA-1', enc.encode(str));
         return Array.from(new Uint8Array(hash))
            .map(v => v.toString(16).padStart(2, '0'))
            .join('');
      }
   </script>
   <script>
      function download(dataurl, filename) {
         const link = document.createElement("a");
         link.href = dataurl;
         link.download = filename;
         link.click();
      }

      function setOptionsVisible(visible) {
         document.getElementById("options").style.display = (visible ? "block" : "none");
      }
   </script>
   <script>
      const myForm = document.getElementById("myForm");
      const csvFile = document.getElementById("csvFile");

      myForm.addEventListener("submit", function (e) {
         e.preventDefault();
         const input = csvFile.files[0];
         const reader = new FileReader();

         // ðŸ‘‡ executed when a file is loaded
         reader.onload = async function (e) {
            // ðŸ‘‡ get the text from CSV file
            const text = e.target.result;

            // ðŸ‘‡ parse it using D3.js
            const data = d3.csvParse(text);

            // Find what to do with each column
            const toHash = [];
            const toExclude = [];
            data.columns.forEach(function(column) {
               const value = document.getElementById("select_" + column).value;
               switch (value) {
                  case "Hash":
                     toHash.push(column);
                     break;
                  case "Exclude":
                     toExclude.push(column);
                     break;
               }
            });
            console.log(toHash);
            console.log(toExclude);

            for (var i = 0; i < data.length; i++) {
               // Concatenate strings for hashing
               let stringtohash = "";
               toHash.forEach(function(column) {
                  stringtohash += data[i][column];
               })
               // Hash
               console.log("Hashing: " + stringtohash);
               hash = await sha1(stringtohash);
               console.log("SHA-1: " + hash);

               data[i]["Hash"] = hash;

               // Delete fields in toExclude
               toExclude.forEach(function(column) {
                  delete data[i][column];
               })
            }

            console.log(data);

            var csvContent = "data:text/csv;charset=utf-8," + encodeURI(d3.csvFormat(data));;
            // download(csvContent, "parsedcsv.csv");
         };

         reader.readAsText(input);
      });

      csvFile.addEventListener("change", function (e) {
         e.preventDefault();
         const input = csvFile.files[0];
         const selectsParent = document.getElementById("columnBoxes");

         if (input == null) {
            selectsParent.innerHTML = "";
            setOptionsVisible(false);
            return;
         }

         const reader = new FileReader();

         // ðŸ‘‡ executed when a file is loaded
         reader.onload = async function (e) {
            // ðŸ‘‡ get the text from CSV file
            const text = e.target.result;

            // ðŸ‘‡ parse it using D3.js
            const data = d3.csvParse(text);

            // Add drop-down for each field
            const options = ["Keep", "Hash", "Exclude"];
            data.columns.forEach(function(name) {
               // Label
               const label = document.createElement("label");
               const id = "select_" + name;
               label.for = id;
               label.textContent = name + ":  ";
               selectsParent.appendChild(label);
               // Select
               const select = document.createElement("select");
               select.id = id;
               selectsParent.appendChild(select);
               options.forEach(function(optionName) {
                  const option = document.createElement("option");
                  option.value = optionName;
                  option.text = optionName;
                  select.appendChild(option);
               });
               // Line break
               selectsParent.appendChild(document.createElement("br"));
            });

            // Show options
            setOptionsVisible(true);
         };

         // ðŸ‘‡ load the input file to the reader
         reader.readAsText(input);
      });
   </script>
</body>
</html>
